<div class="fixed inset-0 z-40" style="background:rgba(0,0,0,.65)"></div>
<div class="fixed inset-0 z-50 grid place-items-center p-4">
  <div class="w-full max-w-3xl rounded-xl border border-white/10 bg-[#0f1114] text-gray-100"
       style="box-shadow:0 0 0 1px rgba(255,255,255,.04) inset">
    <!-- header + stepper ... -->

    <form class="p-6 space-y-6" [formGroup]="form" (ngSubmit)="submit()">

      <!-- Шаг 1: name ... -->

      <!-- Шаг 2: trigger + schedule -->
      @if (step === 2) {
        <div class="space-y-4">
          <!-- радио триггеры ... -->
          @if (trigger === 'push') {
            <div>
              <label class="text-sm text-gray-300">Branch</label>
              <input formControlName="branch" class="mt-1 w-full h-11 rounded-md border border-white/10 bg-white/5 px-3 text-sm" />
            </div>
          }
          @if (trigger === 'schedule') {
            <div formGroupName="schedule" class="grid gap-3 md:grid-cols-2">
              <div>
                <label class="text-sm text-gray-300">Schedule Type</label>
                <select formControlName="type" class="mt-1 w-full h-11 rounded-md border border-white/10 bg-white/5 px-3 text-sm">
                  <option value="daily">Daily</option>
                  <option value="weekly">Weekly</option>
                  <option value="cron">Cron</option>
                </select>
              </div>
              <div>
                <label class="text-sm text-gray-300">Cron (если Cron)</label>
                <input formControlName="cron" class="mt-1 w-full h-11 rounded-md border border-white/10 bg-white/5 px-3 text-sm" placeholder="0 2 * * *" />
              </div>
            </div>
          }
        </div>
      }

      <!-- Шаг 3: агенты -->
      @if (step === 3) {
        <div formArrayName="agents" class="grid grid-cols-1 sm:grid-cols-3 gap-3">
          @for (ctrl of agentsArray.controls; track $index; let i = $index) {
            <label class="flex items-center gap-2 rounded-md border border-white/10 bg-white/5 px-3 py-2 text-sm hover:bg-white/10 cursor-pointer">
              <input type="checkbox" [formControl]="ctrl" class="h-4 w-4 rounded border-white/20 bg-black/30" />
              <span>{{ agentDefs[i].label }}</span>
            </label>
          }
        </div>
        <div class="mt-3">
          <label class="text-sm text-gray-300">Notes / Rules (optional)</label>
          <textarea formControlName="notes" class="mt-1 w-full min-h-[100px] rounded-md border border-white/10 bg-white/5 px-3 py-2 text-sm"></textarea>
        </div>
      }

      <!-- Шаг 4: Summary -->
      @if (step === 4) {
        <div class="space-y-3 text-sm">
          <div><span class="text-gray-400">Name:</span> <span class="text-white">{{ form.value.name }}</span></div>
          <div><span class="text-gray-400">Trigger:</span> <span class="text-white">{{ form.value.trigger }}</span></div>
          @if (form.value.trigger === 'push') {
            <div><span class="text-gray-400">Branch:</span> <span class="text-white">{{ form.value.branch }}</span></div>
          }
          @if (form.value.trigger === 'schedule') {
            <div>
              <span class="text-gray-400">Schedule:</span>
              <span class="text-white">{{ form.value.schedule?.type }}</span>
              @if (form.value.schedule?.type === 'cron') {
                <span class="text-gray-400"> — Cron: </span>
                <span class="text-white">{{ form.value.schedule?.cron }}</span>
              }
            </div>
          }
          <div>
            <span class="text-gray-400">Agents:</span>
            <span class="text-white">
              @for (ctrl of agentsArray.controls; track $index) {
                @if (ctrl.value) { <span class="mr-2">{{ agentDefs[$index].label }}</span> }
              }
            </span>
          </div>
        </div>
      }

      <!-- footer -->
      <div class="flex items-center justify-between pt-4">
        <button type="button" (click)="close()" class="h-10 px-3 rounded-md border border-white/10 bg-white/5 text-sm">Cancel</button>
        <div class="flex items-center gap-2">
          <button type="button" (click)="prev()" class="h-10 px-3 rounded-md border border-white/10 bg-white/5 text-sm" [disabled]="step===1">Previous</button>
          <button *ngIf="step<4" type="button" (click)="next()" class="h-10 px-4 rounded-md bg-blue-600/90 hover:bg-blue-600 text-white text-sm font-medium">Next</button>
          <button *ngIf="step===4" type="submit" class="h-10 px-4 rounded-md bg-blue-600/90 hover:bg-blue-600 text-white text-sm font-medium">Create</button>
        </div>
      </div>
    </form>
  </div>
</div>
